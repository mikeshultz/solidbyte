from solidbyte.compile.linker import (
    placeholder_from_def,
    contract_from_def,
    bytecode_link_defs,
    replace_placeholders,
)
from solidbyte.common.web3 import remove_0x

CONTRACT_NAME_1 = "MyContract"
CONTRACT_PLACEHOLDER_1 = "$13811623e8434e588b8942cf9304d14b96$"
CONTRACT_BIN_FILE_1 = """17f8d6292e50616f31b409949cc5ff8e6aafdc087bba4b16f1d71c270c20af1ed839181900360600190a350610c85565b600782810b900b60009081526002602052604090206004015460011115611051576040805160208082526013908201527f6e6f7468696e6720746f207769746864726177000000000000000000000000008183015290513391600785900b917f8d6292e50616f31b409949cc5ff8e6aafdc087bba4b16f1d71c270c20af1ed839181900360600190a350610c85565b600782810b900b600090815260026020526040808220600480820154600a9092015483517f9a3b7f280000000000000000000000000000000000000000000000000000000081529182019290925260248101919091528151839273__$13811623e8434e588b8942cf9304d14b96$__92639a3b7f289260448083019392829003018186803b1580156110e257600080fd5b505af41580156110f6573d6000803e3d6000fd5b505050506040513d604081101561110c57600080fd5b50805160209091015190925090506000821161112457fe5b600784810b900b6000908152600260205260409020600a015460011480156111635750600784810b900b60009081526002602052604090206004015482145b806111a85750600784810b900b6000908152600260205260409020600a015460011080156111a85750600784810b900b60009081526002602052604090206004015482105b15156111b057fe5b600784810b900b6000908152600260205260409020600a01805460019190859081106111d85

// {} -> /path/to/contracts/{}.sol:{}""".format(CONTRACT_PLACEHOLDER_1, CONTRACT_NAME_1,
                                                CONTRACT_NAME_1)
CONTRACT_DEF_1 = "// {} -> /path/to/contracts/{}.sol:{}".format(CONTRACT_PLACEHOLDER_1,
                                                                CONTRACT_NAME_1, CONTRACT_NAME_1)
CONTRACT_PLACEHOLDER_MATCH_1 = "__{}__".format(CONTRACT_PLACEHOLDER_1)
ADDRESS_1 = "0x00000000000000000deadbeef111123452123456"


def test_placeholder_from_def():
    pholder = placeholder_from_def(CONTRACT_DEF_1)
    assert pholder == CONTRACT_PLACEHOLDER_1


def test_contract_from_def():
    name = contract_from_def(CONTRACT_DEF_1)
    assert name == CONTRACT_NAME_1


def test_bytecode_link_defs():
    defs = bytecode_link_defs(CONTRACT_DEF_1)
    assert len(defs) == 1
    assert defs[0][0] == CONTRACT_NAME_1
    assert defs[0][1] == CONTRACT_PLACEHOLDER_1


def test_replace_placeholders():
    replaced = replace_placeholders(CONTRACT_BIN_FILE_1, CONTRACT_PLACEHOLDER_1, ADDRESS_1)
    replaced_no_comments = ''.join([x for x in replaced.split('\n') if not x.startswith('//')])
    # TODO: Expand on this
    assert replaced != CONTRACT_DEF_1
    assert remove_0x(ADDRESS_1) in replaced, replaced
    assert CONTRACT_PLACEHOLDER_1 not in replaced_no_comments
